# ---
# # Source: banking-api/templates/priorityclass.yaml
# apiVersion: scheduling.k8s.io/v1
# kind: PriorityClass
# metadata:
#   name: banking-api-critical
#   labels:
#     app: banking-api
# value: 1000
# globalDefault: false
# description: "Banking API - critical workload"
# ---
# # Source: banking-api/templates/networkpolicy.yaml
# apiVersion: networking.k8s.io/v1
# kind: NetworkPolicy
# metadata:
#   name: banking-api
#   namespace: "banking-api"
#   labels:
#     app: banking-api
#     version: 1.0.0
# spec:
#   podSelector:
#     matchLabels:
#       app: banking-api
#   policyTypes:
#     - Ingress
#     - Egress
  
#   # Ingress: Allow traffic from same namespace (CronJob to API)
#   ingress:
#     - from:
#         - podSelector:
#             matchLabels:
#               app: banking-api
#       ports:
#         - protocol: TCP
#           port: 4000
  
#   # Egress: Allow DNS and internal communication
#   egress:
#     # Allow DNS queries
#     - to:
#         - namespaceSelector: {}
#       ports:
#         - protocol: UDP
#           port: 53
    
#     # Allow to same pod (localhost)
#     - to:
#         - podSelector:
#             matchLabels:
#               app: banking-api
#       ports:
#         - protocol: TCP
#           port: 4000
# ---
# # Source: banking-api/templates/resourcequota.yaml
# apiVersion: v1
# kind: ResourceQuota
# metadata:
#   name: banking-api-quota
#   namespace: banking-api
#   labels:
#     app: banking-api
# spec:
#   hard:
#     requests.cpu: "5"
#     limits.cpu: "10"
#     requests.memory: "5Gi"
#     limits.memory: "10Gi"
#     requests.storage:
# ---
# # Source: banking-api/templates/poddisruptionbudget.yaml
# apiVersion: policy/v1
# kind: PodDisruptionBudget
# metadata:
#   name: banking-api
#   namespace: "banking-api"
#   labels:
#     app: banking-api
#     version: 1.0.0
# spec:
#   minAvailable: 1
#   selector:
#     matchLabels:
#       app: banking-api
#   unhealthyPodEvictionPolicy: IfHealthyBudget
# ---
# # Source: banking-api/templates/serviceaccount.yaml
# apiVersion: v1
# kind: ServiceAccount
# metadata:
#   name: banking-api
#   labels:
#     app: banking-api
#     version: 1.0.0
# automountServiceAccountToken: true
# ---
# # Source: banking-api/templates/configmap-nginx.yaml
# apiVersion: v1
# kind: ConfigMap
# metadata:
#   name: banking-api-nginx
#   labels:
#     app.kubernetes.io/name: banking-api
#     app.kubernetes.io/version: 1.0.0
# data:
#   nginx.conf: |
#     user nginx;
#     worker_processes auto;
#     error_log /var/log/nginx/error.log warn;
#     pid /var/run/nginx.pid;
    
#     events {
#       worker_connections 1024;
#     }
    
#     http {
#       include /etc/nginx/mime.types;
#       default_type application/octet-stream;

#       # Normal log format
#       log_format main '$remote_addr - [$time_local] "$request" $status $body_bytes_sent';

#       # Slow request log format
#       log_format slow_requests '[SLOW_REQUEST] [$time_local] Remote: $remote_addr | Request: $request | Status: $status | Time: $request_time s';

#       map $request_time $slow {
#         "~^0\.00[2-9]" 1;      # 0.002–0.009 sec
#         "~^0\.0[1-9]\d" 1;     # 0.01–0.09 sec
#         "~^0\.[1-9]\d+" 1;     # 0.1–0.9 sec
#         "~^[1-9]\d*" 1;        # ≥1 sec
#         default 0;             # <= 0.001 sec
#       }

#       access_log /var/log/nginx/access.log main;

#       sendfile on;
#       tcp_nopush on;
#       tcp_nodelay on;
#       keepalive_timeout 65;
#       types_hash_max_size 2048;

#       upstream banking_api {
#         server localhost:4000;
#       }

#       server {
#         listen 80;
#         server_name _;

#         location / {  
#           proxy_pass http://banking_api;
#           proxy_set_header Host $host;
#           proxy_set_header X-Real-IP $remote_addr;
#           proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#           proxy_set_header X-Forwarded-Proto $scheme;

#           # Only log requests > 0.001 sec
#           access_log /var/log/nginx/slow_requests.log slow_requests if=$slow buffer=32k flush=5s;
#         }
#       }
#     }
# ---
# # Source: banking-api/templates/configmap.yaml
# apiVersion: v1
# kind: ConfigMap
# metadata:
#   name: banking-api-config-template
#   namespace: banking-api
#   labels:
#     app.kubernetes.io/name: banking-api
# data:
#   config.json: |
#     {
#       "port": 4000,
#       "adminApiKey": "${ADMIN_API_KEY}"
#     }
# ---
# # Source: banking-api/templates/role.yaml
# apiVersion: rbac.authorization.k8s.io/v1
# kind: Role
# metadata:
#   name: banking-api
#   labels:
#     app: banking-api
# rules:
# - apiGroups: [""]
#   resources: ["pods", "pods/log"]
#   verbs: ["get", "list"]
# - apiGroups: ["batch"]
#   resources: ["jobs"]
#   verbs: ["get", "list"]
# - apiGroups: [""]
#   resources: ["secrets"]
#   resourceNames: ["banking-api-api-key"]
#   verbs: ["get"]
# ---
# # Source: banking-api/templates/rolebinding.yaml
# apiVersion: rbac.authorization.k8s.io/v1
# kind: RoleBinding
# metadata:
#   name: banking-api
#   labels:
#     app: banking-api
# roleRef:
#   apiGroup: rbac.authorization.k8s.io
#   kind: Role
#   name: banking-api
# subjects:
# - kind: ServiceAccount
#   name: banking-api
#   namespace: banking-api
# ---
# # Source: banking-api/templates/service.yaml
# apiVersion: v1
# kind: Service
# metadata:
#   name: banking-api
#   labels:
#     app: banking-api
# spec:
#   type: ClusterIP
#   ports:
#     - port: 80
#       targetPort: http
#       protocol: TCP
#       name: http
#     - port: 4000
#       targetPort: app-port
#       protocol: TCP
#       name: app
#   selector:
#     app: banking-api
# ---
# # Source: banking-api/templates/deployment.yaml
# apiVersion: apps/v1
# kind: Deployment
# metadata:
#   name: banking-api
#   labels:
#     app: banking-api
#     version: 1.0.0
# spec:
#   replicas: 1
#   selector:
#     matchLabels:
#       app: banking-api
#   template:
#     metadata:
#       labels:
#         app: banking-api
#         version: 1.0.0
#     spec:
#       serviceAccountName: banking-api
#       priorityClassName: banking-api-critical
#       securityContext:
#         runAsNonRoot: true
#         runAsUser: 1000
#         fsGroup: 2000
#         seccompProfile:
#           type: RuntimeDefault
#       initContainers:
#         - name: config-init
#           image: busybox:1.37.0
#           command: ['sh', '-c']
#           args:
#             - |
#               sed "s|\${ADMIN_API_KEY}|${ADMIN_API_KEY}|g" /mnt/config-template/config.json > /config/config.json
#               chmod 444 /config/config.json
#           env:
#             - name: ADMIN_API_KEY
#               valueFrom:
#                 secretKeyRef:
#                   name: banking-api-key
#                   key: adminApiKey
#           resources:
#             requests:
#               cpu: 10m
#               memory: 32Mi
#             limits:
#               cpu: 50m
#               memory: 64Mi
#           volumeMounts:
#             - name: config-template
#               mountPath: /mnt/config-template
#             - name: app-config
#               mountPath: /config
#       containers:
#         - name: banking-api
#           image: banking-api:v1.0.0
#           imagePullPolicy: IfNotPresent
#           securityContext:
#             allowPrivilegeEscalation: false
#             readOnlyRootFilesystem: false
#             runAsNonRoot: true
#             runAsUser: 1000
#             capabilities:
#               drop:
#                 - ALL
#           ports:
#             - name: app-port
#               containerPort: 4000
#               protocol: TCP
#           env:
#             - name: CONFIG_FILE
#               value: /config/config.json
#             - name: MEMORY_LIMIT
#               valueFrom:
#                 resourceFieldRef:
#                   resource: limits.memory
#           livenessProbe:
#             httpGet:
#               path: /ping
#               port: app-port
#             initialDelaySeconds: 30
#             periodSeconds: 10
#             timeoutSeconds: 5
#             failureThreshold: 3
#           readinessProbe:
#             httpGet:
#               path: /ping
#               port: app-port
#             initialDelaySeconds: 20
#             periodSeconds: 5
#             timeoutSeconds: 3
#             failureThreshold: 2
#           resources:
#             requests:
#               cpu: 250m
#               memory: 256Mi
#             limits:
#               cpu: 500m
#               memory: 512Mi
#           volumeMounts:
#             - name: app-config
#               mountPath: /config

#         - name: nginx-proxy
#           image: nginx:1.26.1-alpine
#           imagePullPolicy: IfNotPresent
#           securityContext:
#             allowPrivilegeEscalation: false
#             readOnlyRootFilesystem: true
#             runAsNonRoot: true
#             runAsUser: 101
#             capabilities:
#               drop:
#                 - ALL
#               add:
#                 - NET_BIND_SERVICE
#           ports:
#             - name: http
#               containerPort: 80
#               protocol: TCP
#           resources:
#             requests:
#               cpu: 100m
#               memory: 128Mi
#             limits:
#               cpu: 200m
#               memory: 256Mi
#           volumeMounts:
#             - name: nginx-config
#               mountPath: /etc/nginx/nginx.conf
#               subPath: nginx.conf
#             - name: nginx-cache
#               mountPath: /var/cache/nginx
#             - name: nginx-run
#               mountPath: /var/run
#             - name: nginx-logs
#               mountPath: /var/log/nginx
#             - name: nginx-conf-d
#               mountPath: /etc/nginx/conf.d
#       volumes:
#         - name: config-template
#           configMap:
#             name: banking-api-config-template
#             defaultMode: 0444
#         - name: app-config
#           emptyDir:
#             medium: Memory
#             sizeLimit: 10Mi


#         - name: nginx-config
#           configMap:
#             name: banking-api-nginx
#         - name: nginx-cache
#           emptyDir:
#             medium: Memory
#             sizeLimit: 50Mi
#         - name: nginx-run
#           emptyDir:
#             medium: Memory
#             sizeLimit: 10Mi
#         - name: nginx-logs
#           emptyDir:
#             medium: Memory
#             sizeLimit: 100Mi
#         - name: nginx-conf-d
#           emptyDir:
#             medium: Memory
#             sizeLimit: 10Mi
# ---
# # Source: banking-api/templates/cronjob.yaml
# apiVersion: batch/v1
# kind: CronJob
# metadata:
#   name: banking-api-balance-check
#   labels:
#     app: banking-api
#     job-type: cronjob
# spec:
#   schedule: "*/1 * * * *"
#   successfulJobsHistoryLimit: 3
#   failedJobsHistoryLimit: 5
  
#   jobTemplate:
#     spec:
#       activeDeadlineSeconds: 300
#       backoffLimit: 0
      
#       template:
#         metadata:
#           labels:
#             app: banking-api
#             job-type: cronjob
#           annotations:
#             description: "Daily balance checker job for low balance alerts"
#         spec:
#           serviceAccountName: banking-api
          
#           securityContext:
#             runAsNonRoot: true
#             runAsUser: 65534
#             fsGroup: 65534
#             seccompProfile:
#               type: RuntimeDefault
          
#           containers:
#           - name: balance-checker
#             image: curlimages/curl:8.17.0
#             imagePullPolicy: IfNotPresent
            
#             env:
#               - name: API_URL
#                 value: "http://banking-api:4000"
#               - name: API_KEY
#                 valueFrom:
#                   secretKeyRef:
#                     name: banking-api-key
#                     key: adminApiKey
#               - name: THRESHOLD
#                 value: "10000"
#               - name: ALERT_EMAIL
#                 value: "alert@example.org"
            
#             securityContext:
#               allowPrivilegeEscalation: false
#               readOnlyRootFilesystem: true
#               runAsNonRoot: true
#               runAsUser: 65534
#               capabilities:
#                 drop:
#                   - ALL
            
#             command: ["/bin/sh"]
#             args:
#               - -c
#               - |
#                 #!/bin/sh
#                 set -e

#                 echo "[$(date -u +'%Y-%m-%d %H:%M:%S')] Starting balance check (threshold: -$THRESHOLD)"

#                 # Fetch all accounts from the API
#                 response=$(curl -s -X GET \
#                   -H "x-api-key: $API_KEY" \
#                   -H "Content-Type: application/json" \
#                   "$API_URL/admin/accounts")

#                 # Look for accounts with a balance lower than the negative threshold
#                 if echo "$response" | grep -qE '"balance":-[0-9]{5,}'; then
#                   echo "ALERT: One or more accounts have a very low balance (below -$THRESHOLD)"
#                   echo "Alert email: $ALERT_EMAIL"
#                   exit 0
#                 else
#                   echo "OK: No accounts found with critically low balance"
#                   exit 0
#                 fi

            
#             # Resource requests and limits
#             resources:
#               requests:
#                 memory: "64Mi"
#                 cpu: "50m"
#               limits:
#                 memory: "128Mi"
#                 cpu: "200m"
            
#             # Volume mounts for temporary storage
#             volumeMounts:
#               - name: tmp
#                 mountPath: /tmp
          
#           volumes:
#             - name: tmp
#               emptyDir: {}
          
#           restartPolicy: OnFailure
# ---
# # Source: banking-api/templates/hpa.yaml
# # hpa is disabled
# # The banking-api uses in-memory state and cannot be horizontally scaled
# # If we attach persistent storage, we may use this configiration
# #
# # apiVersion: autoscaling/v2
# # kind: HorizontalPodAutoscaler
# # metadata:
# #   name: banking-api
# #   labels:
# #     app: banking-api
# # spec:
# #   scaleTargetRef:
# #     apiVersion: apps/v1
# #     kind: Deployment
# #     name: banking-api
# #   minReplicas: 1
# #   maxReplicas: 3
# #   metrics:
# #   - type: Resource
# #     resource:
# #       name: cpu
# #       target:
# #         type: Utilization
# #         averageUtilization: 80
# ---
# # Source: banking-api/templates/ingress.yaml
# # This is an ingress template file for the banking-api application. Since this setup reuires to modify the /etc/hosts file in the system, 
# # so we are not using this approch for now. The ingress resource is commented out.

# # apiVersion: networking.k8s.io/v1
# # kind: Ingress
# # metadata:
# #   name: banking-api
# #   namespace: banking-production
# #   labels:
# #     app: banking-api
# # spec:
# #   rules:
# #   - host: banking-api.local
# #     http:
# #       paths:
# #       - path: /
# #         pathType: Prefix
# #         backend:
# #           service:
# #             name: banking-api
# #             port:
# #               number: 80
# ---
# # Source: banking-api/templates/secret.yaml
# # NOTE: Secrets are pre-created outside of Helm for security reasons.
# # 
# # Create the secret with:
# # kubectl create secret generic banking-api-key \
# #   --from-literal=adminApiKey=YOUR_SECRET_KEY \
# #   -n banking-api
# ---
# # Source: banking-api/templates/vpa.yaml
# # TO add VPA, we need metric servers and other components installed in the cluster. This is a demo config.

# # apiVersion: autoscaling.k8s.io/v1
# # kind: VerticalPodAutoscaler
# # metadata:
# #   name: banking-api
# #   namespace: banking-api
# #   labels:
# #      app: banking-api
# # spec:
# #   targetRef:
# #     apiVersion: apps/v1
# #     kind: Deployment
# #     name: banking-api
# #   updatePolicy:
# #     updateMode: "Off"
# ---
# # Source: banking-api/templates/tests/test-connection.yaml
# apiVersion: v1
# kind: Pod
# metadata:
#   name: "banking-api-test-connection"
#   labels:
#     helm.sh/chart: banking-api-1.0.0
#     app.kubernetes.io/name: banking-api
#     app.kubernetes.io/instance: banking-api
#     app.kubernetes.io/version: "1.0.0"
#     app.kubernetes.io/managed-by: Helm
#   annotations:
#     "helm.sh/hook": test
# spec:
#   containers:
#     - name: wget
#       image: busybox
#       command: ['wget']
#       args: ['banking-api:4000/ping']
#   restartPolicy: Never
