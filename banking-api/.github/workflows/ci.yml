# Author: Sameed Shoaib
# Date: 29-11-2025

name: CI Pipeline

# The piepline will trigger on dev branch push
on:
  push:
    branches: [dev]

jobs:
  test-and-scan:
  # Ccheck out the code, and will give full git history
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9.14.4

      - name: Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: Run Unit Tests
        run: pnpm test --reporter=json --outputFile=test-results.json || true

      - name: Build
        run: pnpm run build

      - name: Dependency Scan
        run: npm audit --production --json > dependency-report.json || echo "Vulnerabilities found"

      - name: File System Scan with Trivy
        uses: aquasecurity/trivy-action@0.20.0
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-fs-results.sarif'
          skip-dirs: 'node_modules,dist,.git'

      - name: Upload Scan Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: scan-reports
          path: |
            test-results.json
            dependency-report.json
            trivy-fs-results.sarif

      - name: Upload Trivy SARIF to Security
        if: always()
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: 'trivy-fs-results.sarif'
          category: 'trivy-fs-scan'

      - uses: SonarSource/sonarqube-scan-action@1.5.0
        env:
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          args: -Dsonar.projectKey=banking-api -Dsonar.sources=src
        continue-on-error: true
