# Author: Sameed Shoaib
# Date: 29-11-2025

name: Secure CD Pipeline

on:
  pull_request:
    branches: [main, staging, dev]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  IMAGE_TAG: ${{ github.sha }}

# Github Permissions
permissions:
  contents: write
  packages: write
  pull-requests: write
  security-events: write
  id-token: write

# Build, unit tests, and security scans
jobs:
  build-and-test:
    name: Build & Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - uses: pnpm/action-setup@v2
        with:
          version: 9.14.4

      - run: pnpm install --frozen-lockfile

      - name: Run Unit Tests
        run: pnpm test --reporter=json --outputFile=test-results.json || true

      - run: pnpm run build

      - name: Dependency Scan
        run: npm audit --production --json > dependency-report.json || echo "Vulnerabilities found"

      - name: File System Scan with Trivy
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-fs-results.sarif'
          skip-dirs: 'node_modules,dist,.git'

      - name: Upload Scan Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: scan-reports
          path: |
            test-results.json
            dependency-report.json
            trivy-fs-results.sarif

      - name: Upload Trivy SARIF to Security
        if: always()
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: 'trivy-fs-results.sarif'
          category: 'trivy-fs-scan'

  # Build, sign, and push Docker image
  build-image:
    name: Build & Sign Image
    runs-on: ubuntu-latest
    needs: build-and-test
    outputs:
      image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
      digest: ${{ steps.build.outputs.digest }}
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - uses: sigstore/cosign-installer@v3

      - id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - run: cosign sign --yes ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}

      - uses: anchore/sbom-action@v0
        with:
          image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
          format: spdx-json
          output-file: sbom.spdx.json

      - run: cosign attest --yes --predicate sbom.spdx.json ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
  
  # Scan Docker image for vulnerabilities one final time
  scan-image:
    name: Scan Image
    runs-on: ubuntu-latest
    needs: build-image
    steps:
      - name: Scan Image for Vulnerabilities
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ needs.build-image.outputs.image }}
          format: sarif
          output: image-results.sarif

      - name: Upload Image Scan SARIF
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: image-results.sarif

      - name: Display Image Scan Results
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ needs.build-image.outputs.image }}
          format: table
          exit-code: '0'


  update-config:
    name: Update Deployment Config
    runs-on: ubuntu-latest
    needs: [build-image, scan-image]
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Determine environment from branch
      run: |
        # Map git branch to environment name
        if [[ "${{ github.base_ref }}" == "main" ]]; then
          ENVIRONMENT="production"
        elif [[ "${{ github.base_ref }}" == "staging" ]]; then
          ENVIRONMENT="staging"
        else
          ENVIRONMENT="dev"
        fi
        
        # Save for use in other steps
        echo "ENVIRONMENT=$ENVIRONMENT" >> $GITHUB_ENV

    - name: Update Helm values file
      run: |
        # Create the values file path
        VALUES_FILE="helm/values.${ENVIRONMENT}.yaml"
        
        # Update the image tag in the values file
        sed -i "s/tag: .*/tag: ${{ env.IMAGE_TAG }}/g" "$VALUES_FILE"
        
        # Confirm the update
        echo "Updated $VALUES_FILE"
        echo "New tag: ${{ env.IMAGE_TAG }}"

    # This will push the changes into the repo, and based on out ArgoCD setup, it will deploy to the desired env
    - name: Commit and push changes
      run: |
        # Configure git user for commits
        git config user.name "sameed"
        git config user.email "sameedshoaib@live.co.uk"
        
        # Stage the updated values file
        git add "helm/values.${ENVIRONMENT}.yaml"
        git commit -m "chore: update image tag to ${{ env.IMAGE_TAG }} for $ENVIRONMENT"
        git push
        echo "Changes pushed successfully"

