---
# Simple Infrastructure Setup Playbook
# Installs Docker, Kubernetes, Helm, Jenkins, and configures Ubuntu server

- name: Setup Infrastructure
  hosts: all
  become: true
  gather_facts: true

  tasks:
    # ========================================
    # 1. SYSTEM UPDATE
    # ========================================
    - name: Update apt cache and upgrade packages
      apt:
        update_cache: yes
        upgrade: dist
        autoremove: yes

    - name: Install essential packages
      apt:
        name:
          - apt-transport-https
          - ca-certificates
          - curl
          - gnupg
          - software-properties-common
          - python3-pip
        state: present

    # ========================================
    # 2. CREATE NON-ROOT USER
    # ========================================
    - name: Create devops user
      user:
        name: "{{ devops_user }}"
        groups: sudo
        shell: /bin/bash
        create_home: yes
        state: present

    - name: Add SSH key for devops user
      authorized_key:
        user: "{{ devops_user }}"
        key: "{{ ssh_public_key }}"
        state: present

    - name: Enable passwordless sudo for devops user
      lineinfile:
        path: /etc/sudoers.d/{{ devops_user }}
        line: "{{ devops_user }} ALL=(ALL) NOPASSWD:ALL"
        create: yes
        mode: '0440'
        validate: 'visudo -cf %s'

    # ========================================
    # 3. INSTALL DOCKER
    # ========================================
    - name: Add Docker GPG key
      apt_key:
        url: https://download.docker.com/linux/ubuntu/gpg
        state: present

    - name: Add Docker repository
      apt_repository:
        repo: "deb [arch=amd64] https://download.docker.com/linux/ubuntu {{ ansible_distribution_release }} stable"
        state: present

    - name: Install Docker
      apt:
        name:
          - docker-ce
          - docker-ce-cli
          - containerd.io
        state: present
        update_cache: yes

    - name: Add users to docker group
      user:
        name: "{{ item }}"
        groups: docker
        append: yes
      loop:
        - "{{ devops_user }}"
        - ubuntu

    - name: Start and enable Docker
      systemd:
        name: docker
        state: started
        enabled: yes

    # ========================================
    # 4. INSTALL KUBERNETES TOOLS
    # ========================================
    - name: Add Kubernetes GPG key
      apt_key:
        url: https://pkgs.k8s.io/core:/stable:/v1.28/deb/Release.key
        state: present
        keyring: /usr/share/keyrings/kubernetes-archive-keyring.gpg

    - name: Add Kubernetes repository
      apt_repository:
        repo: "deb [signed-by=/usr/share/keyrings/kubernetes-archive-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.28/deb/ /"
        state: present

    - name: Install Kubernetes tools
      apt:
        name:
          - kubelet
          - kubeadm
          - kubectl
        state: present
        update_cache: yes

    - name: Hold Kubernetes packages
      dpkg_selections:
        name: "{{ item }}"
        selection: hold
      loop:
        - kubelet
        - kubeadm
        - kubectl

    # ========================================
    # 5. INSTALL HELM
    # ========================================
    - name: Download Helm install script
      get_url:
        url: https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3
        dest: /tmp/get_helm.sh
        mode: '0700'

    - name: Install Helm
      shell: /tmp/get_helm.sh
      args:
        creates: /usr/local/bin/helm

    # ========================================
    # 6. INSTALL JENKINS
    # ========================================
    - name: Add Jenkins GPG key
      apt_key:
        url: https://pkg.jenkins.io/debian-stable/jenkins.io-2023.key
        state: present

    - name: Add Jenkins repository
      apt_repository:
        repo: "deb https://pkg.jenkins.io/debian-stable binary/"
        state: present

    - name: Install Java (required for Jenkins)
      apt:
        name: openjdk-17-jdk
        state: present
        update_cache: yes

    - name: Install Jenkins
      apt:
        name: jenkins
        state: present

    - name: Add jenkins user to docker group
      user:
        name: jenkins
        groups: docker
        append: yes

    - name: Start and enable Jenkins
      systemd:
        name: jenkins
        state: started
        enabled: yes

    - name: Wait for Jenkins to start (port 8080)
      wait_for:
        port: 8080
        host: localhost
        timeout: 120

    - name: Check if Jenkins initial password exists
      stat:
        path: /var/lib/jenkins/secrets/initialAdminPassword
      register: jenkins_password_file

    - name: Get Jenkins initial password
      slurp:
        src: /var/lib/jenkins/secrets/initialAdminPassword
      register: jenkins_password
      when: jenkins_password_file.stat.exists

    - name: Display Jenkins password
      debug:
        msg: "Jenkins password: {{ jenkins_password['content'] | b64decode }}"
      when: jenkins_password_file.stat.exists

    - name: Display message if password file not found
      debug:
        msg: "Jenkins already configured or password file not found. Check Jenkins UI."
      when: not jenkins_password_file.stat.exists

    # ========================================
    # 6.1 CONFIGURE JENKINS USER PRIVILEGES
    # ========================================
    - name: Enable passwordless sudo for jenkins user
      lineinfile:
        path: /etc/sudoers.d/jenkins
        line: "jenkins ALL=(ALL) NOPASSWD:ALL"
        create: yes
        mode: '0440'
        validate: 'visudo -cf %s'

    - name: Create .kube directory for jenkins user
      file:
        path: /var/lib/jenkins/.kube
        state: directory
        owner: jenkins
        group: jenkins
        mode: '0755'

    - name: Copy kubeconfig to jenkins user (if exists)
      copy:
        src: /etc/kubernetes/admin.conf
        dest: /var/lib/jenkins/.kube/config
        owner: jenkins
        group: jenkins
        mode: '0600'
        remote_src: yes
      ignore_errors: yes

    - name: Set KUBECONFIG in jenkins profile
      lineinfile:
        path: /var/lib/jenkins/.bashrc
        line: "export KUBECONFIG=/var/lib/jenkins/.kube/config"
        create: yes
        owner: jenkins
        group: jenkins

    # ========================================
    # 7. CONFIGURE FIREWALL (UFW)
    # ========================================
    - name: Install UFW
      apt:
        name: ufw
        state: present

    - name: Allow firewall ports
      ufw:
        rule: allow
        port: "{{ item }}"
        proto: tcp
      loop: "{{ firewall_ports }}"

    - name: Enable UFW
      ufw:
        state: enabled

    # ========================================
    # 8. DISABLE SWAP (for Kubernetes)
    # ========================================
    - name: Disable swap
      command: swapoff -a
      when: ansible_swaptotal_mb > 0

    - name: Remove swap from /etc/fstab
      lineinfile:
        path: /etc/fstab
        regexp: '^\s*([^#\s]+\s+){1}(none|swap)\s+'
        state: absent

    # ========================================
    # 9. DEPLOY TEST NGINX CONTAINER
    # ========================================
    - name: Pull NGINX image
      docker_image:
        name: nginx
        tag: alpine
        source: pull

    - name: Run NGINX test container
      docker_container:
        name: nginx-test
        image: nginx:alpine
        state: started
        restart_policy: unless-stopped
        ports:
          - "8888:80"

    - name: Test NGINX accessibility
      uri:
        url: http://localhost:8888
        status_code: 200
      retries: 3
      delay: 5

    # ========================================
    # 10. INITIALIZE KUBERNETES CLUSTER
    # ========================================
    - name: Copy k8s init script
      copy:
        src: scripts/install-k8s.sh
        dest: /tmp/install-k8s.sh
        mode: '0755'

    - name: Run k8s init script
      shell: /tmp/install-k8s.sh
      register: k8s_output

    - name: Show k8s cluster status
      debug:
        var: k8s_output.stdout_lines

    - name: Set up kubeconfig for root user
      copy:
        src: /etc/kubernetes/admin.conf
        dest: /root/.kube/config
        owner: root
        group: root
        mode: '0600'
        remote_src: yes
      ignore_errors: yes

    - name: Create .kube directory for root
      file:
        path: /root/.kube
        state: directory
        mode: '0755'

    # ========================================
    # 11. INSTALL ARGOCD
    # ========================================
    - name: Wait for Kubernetes cluster to be ready
      shell: kubectl get nodes --no-headers=true | grep -q "Ready"
      register: cluster_ready
      until: cluster_ready.rc == 0
      retries: 30
      delay: 10
      environment:
        KUBECONFIG: "/root/.kube/config"

    - name: Create ArgoCD namespace
      shell: kubectl create namespace argocd --dry-run=client -o yaml | kubectl apply -f -
      environment:
        KUBECONFIG: "/root/.kube/config"

    - name: Download ArgoCD manifest
      get_url:
        url: https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml
        dest: /tmp/argocd-install.yaml
        mode: '0644'

    - name: Install ArgoCD
      shell: kubectl apply -n argocd -f /tmp/argocd-install.yaml
      environment:
        KUBECONFIG: "/root/.kube/config"

    - name: Wait for ArgoCD deployment to be ready
      shell: kubectl wait --for=condition=available deployment/argocd-server -n argocd --timeout=300s
      environment:
        KUBECONFIG: "/root/.kube/config"

    - name: Create ArgoCD NodePort service manifest
      copy:
        content: |
          apiVersion: v1
          kind: Service
          metadata:
            name: argocd-server-nodeport
            namespace: argocd
            labels:
              app.kubernetes.io/component: server
              app.kubernetes.io/name: argocd-server
              app.kubernetes.io/part-of: argocd
          spec:
            type: NodePort
            ports:
              - name: server
                port: 80
                protocol: TCP
                targetPort: 8080
                nodePort: 30080
              - name: grpc
                port: 443
                protocol: TCP
                targetPort: 8080
                nodePort: 30443
            selector:
              app.kubernetes.io/name: argocd-server
        dest: /tmp/argocd-nodeport.yaml
        mode: '0644'

    - name: Apply ArgoCD NodePort service
      shell: kubectl apply -f /tmp/argocd-nodeport.yaml
      environment:
        KUBECONFIG: "/root/.kube/config"

    - name: Get ArgoCD initial admin password
      shell: |
        kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 -d
      register: argocd_password
      environment:
        KUBECONFIG: "/root/.kube/config"
      ignore_errors: yes

    - name: Install ArgoCD CLI
      get_url:
        url: "https://github.com/argoproj/argo-cd/releases/latest/download/argocd-linux-amd64"
        dest: /usr/local/bin/argocd
        mode: '0755'

    - name: Create ArgoCD CLI symlink
      file:
        src: /usr/local/bin/argocd
        dest: /usr/local/bin/argocd-cli
        state: link

    - name: Add ArgoCD server port to firewall
      ufw:
        rule: allow
        port: 30080
        proto: tcp
        comment: "ArgoCD Web UI"

    - name: Add ArgoCD gRPC port to firewall
      ufw:
        rule: allow
        port: 30443
        proto: tcp
        comment: "ArgoCD gRPC"

    # ========================================
    # 12. FINAL SETUP SUMMARY
    # ========================================
    - name: Final setup summary
      debug:
        msg: |
          ========================================
          Setup Complete!
          ========================================
          ✓ System updated
          ✓ User '{{ devops_user }}' created with sudo access
          ✓ Docker installed
          ✓ Kubernetes tools installed (kubeadm, kubelet, kubectl)
          ✓ Helm installed
          ✓ Jenkins installed (access at http://{{ ansible_host }}:8080)
          ✓ Jenkins user configured with sudo + kubectl access
          ✓ Firewall configured
          ✓ Swap disabled
          ✓ NGINX test container running on port 8888
          ✓ Kubernetes cluster initialized
          ✓ ArgoCD installed and configured
          ========================================

          Access Information:
          - Jenkins Web UI: http://{{ ansible_host }}:8080
          - ArgoCD Web UI: http://{{ ansible_host }}:30080
          - ArgoCD Admin Password: {{ argocd_password.stdout | default('Check manually with: kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 -d') }}
          - NGINX Test: http://{{ ansible_host }}:8888

          Next Steps:
          1. Access ArgoCD at http://{{ ansible_host }}:30080
          2. Login with username 'admin' and the password shown above
          3. Create your first ArgoCD application
          4. Set up GitOps repository for continuous deployment
          ========================================
